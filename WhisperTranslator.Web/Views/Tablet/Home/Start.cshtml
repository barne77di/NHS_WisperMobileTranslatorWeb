@{
    Layout = "/Views/Tablet/Shared/_Layout.cshtml"; // swap if you have a tablet layout
    var err = TempData["Error"] as string;
}
<section class="t-card">
    <h2 class="nhs-title" style="margin:0;">Whisper Translator</h2>
    <p class="hint" style="margin:6px 0 16px;">Start a new translation or find a previous one.</p>

    <div class="t-actions">
        <button class="t-action" id="btnCreate" aria-describedby="createHelp">
            <span class="t-action__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="30" height="30" focusable="false"><path d="M12 5v14m7-7H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" /></svg>
            </span>
            <span class="t-action__text">
                <strong>Create new Translation</strong>
                <small id="createHelp">Enter or generate a Unique Ref and start</small>
            </span>
        </button>

        <button class="t-action t-action--secondary" id="btnSearch" aria-describedby="searchHelp">
            <span class="t-action__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" width="30" height="30" focusable="false"><path d="M3 7h6l2 2h10v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z" fill="currentColor" /></svg>
            </span>
            <span class="t-action__text">
                <strong>View Previous Translations</strong>
                <small id="searchHelp">Search by date or Unique Ref</small>
            </span>
        </button>
    </div>

    @if (!string.IsNullOrWhiteSpace(err))
    {
        <div class="nhs-alert nhs-alert--error" role="alert">@err</div>
    }
</section>

<!-- CREATE -->
<dialog id="dlgCreate" class="t-modal" aria-labelledby="createTitle">
    <form method="post" action="/Conversations/Create" class="t-modal__panel" novalidate>
        <header class="t-modal__head">
            <h3 id="createTitle" class="nhs-title">Create new Translation</h3>
            <button type="button" class="t-modal__close" aria-label="Close" data-close>✕</button>
        </header>
        <div class="t-modal__body">
            <p class="hint">Enter a Unique Ref or tap “Generate”.</p>
            <div class="mb-3">
                <label for="uniqueRef" class="form-label">Unique Ref</label>
                <div class="t-input-row">
                    <input id="uniqueRef" name="uniqueRef" class="form-control" maxlength="64" required placeholder="NHSTR-2025-0001" />
                    <button type="button" class="pill" id="btnGen">Generate</button>
                </div>
                <div class="nhs-input-hint">Suggested: <code>NHSTR-YYYY-####</code></div>
                <div class="nhs-input-error" id="uniqueRefError" hidden>Please enter a Unique Ref.</div>
            </div>
            @Html.AntiForgeryToken()
        </div>
        <footer class="t-modal__foot">
            <button type="button" class="pill t-btn-muted" data-close>Cancel</button>
            <button type="submit" class="pill">Create</button>
        </footer>
    </form>
</dialog>

<!-- SEARCH -->
<dialog id="dlgSearch" class="t-modal" aria-labelledby="searchTitle">
    <div class="t-modal__panel">
        <header class="t-modal__head">
            <h3 id="searchTitle" class="nhs-title">Find previous translations</h3>
            <button type="button" class="t-modal__close" aria-label="Close" data-close>✕</button>
        </header>
        <div class="t-modal__body">
            <form method="get" action="/Conversations/List" class="t-grid">
                <div class="mb-3">
                    <label class="form-label" for="from">From (UTC)</label>
                    <input class="form-control" type="date" id="from" name="from" />
                </div>
                <div class="mb-3">
                    <label class="form-label" for="to">To (UTC)</label>
                    <input class="form-control" type="date" id="to" name="to" />
                </div>
                <div class="mb-3 t-grid__wide">
                    <label class="form-label" for="ref">Unique Ref</label>
                    <div class="t-input-row">
                        <input class="form-control" type="text" id="ref" name="uniqueRef" placeholder="NHSTR-2025-0001" />
                        <div class="t-quick">
                            <button type="button" class="pill t-btn-muted" data-preset="today">Today</button>
                            <button type="button" class="pill t-btn-muted" data-preset="7">Last 7 days</button>
                            <button type="button" class="pill t-btn-muted" data-preset="30">Last 30 days</button>
                        </div>
                    </div>
                </div>
                <div class="t-modal__foot">
                    <button type="button" class="pill t-btn-muted" data-close>Close</button>
                    <button class="pill" type="submit">Search</button>
                </div>
            </form>
        </div>
    </div>
</dialog>

<script>
    (function(){
      const dlgCreate = document.getElementById('dlgCreate');
      const dlgSearch = document.getElementById('dlgSearch');
      const btnCreate = document.getElementById('btnCreate');
      const btnSearch = document.getElementById('btnSearch');
      const uniqueRef = document.getElementById('uniqueRef');
      const uniqueRefError = document.getElementById('uniqueRefError');
      const btnGen = document.getElementById('btnGen');

      const openDialog = (d) => { d.showModal(); (d.querySelector('input,button,select,textarea')||{}).focus?.(); };
      const closeDialog = (e) => { const d=e.target.closest('dialog'); if (d?.open) d.close(); };

      btnCreate.addEventListener('click', () => openDialog(dlgCreate));
      btnSearch.addEventListener('click', () => openDialog(dlgSearch));
      document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', closeDialog));
      [dlgCreate, dlgSearch].forEach(d => d.addEventListener('cancel', e => e.preventDefault()));

      btnGen.addEventListener('click', () => {
        const now = new Date(), y = now.getUTCFullYear(), n = Math.floor(Math.random()*9000)+1000;
        uniqueRef.value = `NHSTR-${y}-${n}`; uniqueRefError.hidden = true;
      });

      dlgCreate.querySelector('form').addEventListener('submit', (e) => {
        if (!uniqueRef.value.trim()){ e.preventDefault(); uniqueRefError.hidden = false; uniqueRef.focus(); }
      });

      document.querySelectorAll('[data-preset]').forEach(b => {
        b.addEventListener('click', () => {
          const preset = b.getAttribute('data-preset');
          const from = document.getElementById('from');
          const to   = document.getElementById('to');
          const today = new Date();
          const toISO = d => d.toISOString().slice(0,10);
          if (preset === 'today'){ from.value = toISO(today); to.value = toISO(today); }
          else { const d = parseInt(preset,10); const f = new Date(today); f.setDate(today.getDate()-d); from.value = toISO(f); to.value = toISO(today); }
        });
      });
    })();
</script>
